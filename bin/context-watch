#!/usr/bin/env bash
#
# The equivalent of latexmk -pvc for ConTeXt

set -euo pipefail

filename=$1
args=("${@:2}")
if [[ -z $filename ]]; then
    echo >&2 "Usage: $(basename "$0") <filename[.tex]> [args...]"
    exit 1
fi

input_basename=$(basename "$filename")
output_filename="${input_basename%.tex}.pdf"

context "$filename" "${args[@]}"
mimeopen "$output_filename" &
while inotifywait --event modify "$filename"; do
    context "$filename" "${args[@]}" || true
done
